name: Build & push docker images
description: Build and push docker images with native or cross-platform support
inputs:
  docker-config-file:
    required: false
    description: Path to the docker config file (defaults to .docker-config.json) Must contain imageName, may contain dockerfile.
    default: .docker-config.json
  dockerhub-user:
    required: true
    description: DockerHub username
  dockerhub-password:
    required: true
    description: DockerHub password
  push-by-digest:
    required: false
    default: "false"
    description: Push image by digest only (without tags). Mutually exclusive with 'push' - if true, 'push' is ignored.
  image-platform:
    description: Target platform to build image for (e.g., linux/amd64, linux/arm64)
    required: false
    default: linux/amd64
  push:
    required: false
    default: "true"
    description: Push image to registry with tags. Ignored if 'push-by-digest' is true.
  load:
    required: false
    default: "false"
    description: Load image to local docker (single-platform only)
  cache:
    required: false
    default: "true"
    description: Enable Docker layer caching
  cache-tag:
    required: false
    default: buildcache
    description: Cache tag name
  metadata-tags:
    description: Docker metadata-action tags input. See https://github.com/docker/metadata-action#tags-input
    required: false
    default: |
      type=ref,event=branch
      type=ref,event=pr
      type=semver,pattern={{version}}
      type=semver,pattern={{major}}.{{minor}}
      type=semver,pattern={{major}}
  metadata-flavor:
    description: Docker metadata-action flavor input. See https://github.com/docker/metadata-action#flavor-input
    required: false
    default: latest=false
  build-args:
    required: false
    description: List of build arguments as key-value pairs (e.g., KEY=VALUE, one per line)
    default: ""
  secrets:
    required: false
    description: List of build secrets as key-value pairs (e.g., KEY=VALUE, one per line)
    default: ""
  build-contexts:
    required: false
    description: List of build contexts as key-value pairs (e.g., CONTEXT_KEY=VALUE, one per line)
    default: ""
  install-qemu:
    required: false
    default: "false"
    description: Install QEMU for cross-platform builds
  qemu-platforms:
    required: false
    description: QEMU platforms to install (defaults to image-platform if not set)
outputs:
  image-name:
    description: Docker image name
    value: ${{ steps.config.outputs.image-name }}
  image-tags:
    description: Docker image tags generated by metadata-action (newline separated, empty if push-by-digest is true)
    value: ${{ steps.meta.outputs.tags }}
  image:
    description: Full image reference (name:tag or name@digest if push-by-digest is true)
    value: ${{ steps.set-ref.outputs.image-ref }}
  digest:
    description: Image digest
    value: ${{ steps.build.outputs.digest }}
  metadata-json:
    description: JSON output from metadata-action (empty if push-by-digest is true)
    value: ${{ steps.meta.outputs.json }}

runs:
  using: composite
  steps:
    - name: Dump GitHub context
      shell: bash
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - id: config
      name: Read docker config
      shell: bash
      env:
        DOCKER_CONFIG_FILE: ${{ inputs.docker-config-file }}
      run: |
        # Validate docker config file exists
        if [ ! -f "$DOCKER_CONFIG_FILE" ]; then
          echo "::error::Docker config file not found: $DOCKER_CONFIG_FILE" && exit 1
        fi

        # Parse config file
        image_name=$(jq -r .imageName "$DOCKER_CONFIG_FILE")
        if [ -z "$image_name" ] || [ "$image_name" = "null" ]; then
          echo "::error::imageName not found in $DOCKER_CONFIG_FILE" && exit 1
        fi
        echo "image-name: ${image_name}"
        echo "image-name=${image_name}" >> $GITHUB_OUTPUT

        dockerfile=$(jq -r '.dockerfile // "./Dockerfile"' "$DOCKER_CONFIG_FILE")
        echo "Dockerfile: ${dockerfile}"
        echo "dockerfile=${dockerfile}" >> $GITHUB_OUTPUT

        target=$(jq -r '.target // ""' "$DOCKER_CONFIG_FILE")
        echo "Target: ${target}"
        echo "target=${target}" >> $GITHUB_OUTPUT

        # Set tag suffix if target is specified
        if [ -n "$target" ]; then
          tag_suffix="-${target}"
        else
          tag_suffix=""
        fi
        echo "Tag suffix: ${tag_suffix}"
        echo "tag-suffix=${tag_suffix}" >> $GITHUB_OUTPUT

    - name: Set up QEMU
      if: inputs.install-qemu == 'true'
      uses: docker/setup-qemu-action@v3
      with:
        platforms: ${{ inputs.qemu-platforms || inputs.image-platform }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ inputs.dockerhub-user }}
        password: ${{ inputs.dockerhub-password }}

    - name: Docker metadata
      id: meta
      if: inputs.push == 'true' && inputs.push-by-digest == 'false'
      uses: docker/metadata-action@v5
      with:
        images: ${{ steps.config.outputs.image-name }}
        flavor: |
          ${{ inputs.metadata-flavor }}
          suffix=${{ steps.config.outputs.tag-suffix }}
        tags: ${{ inputs.metadata-tags }}

    - name: Build and push
      id: build
      uses: docker/build-push-action@v6
      with:
        context: .
        platforms: ${{ inputs.image-platform }}
        file: ${{ steps.config.outputs.dockerfile }}
        target: ${{ steps.config.outputs.target }}
        build-contexts: ${{ inputs.build-contexts }}
        build-args: |
          GIT_COMMIT=${{ github.sha }}
          ${{ inputs.build-args }}
        secrets: ${{ inputs.secrets }}
        # Push with tags when push=true and not push-by-digest
        push: ${{ inputs.push == 'true' && inputs.push-by-digest == 'false' }}
        load: ${{ inputs.load }}
        # Push by digest only when push-by-digest=true
        outputs: ${{ inputs.push-by-digest == 'true' && format('type=image,"name={0}",push-by-digest=true,name-canonical=true,push=true', steps.config.outputs.image-name) || '' }}
        # Use metadata-generated tags when pushing with tags
        tags: ${{ inputs.push-by-digest == 'false' && steps.meta.outputs.tags || '' }}
        labels: ${{ inputs.push-by-digest == 'false' && steps.meta.outputs.labels || '' }}
        cache-from: ${{ inputs.cache == 'true' && format('type=registry,ref={0}:{1}', steps.config.outputs.image-name, inputs.cache-tag) || '' }}
        cache-to: ${{ inputs.cache == 'true' && format('type=registry,ref={0}:{1},mode=max,compression=zstd', steps.config.outputs.image-name, inputs.cache-tag) || '' }}

    - name: Set image reference output
      id: set-ref
      shell: bash
      env:
        IMAGE_NAME: ${{ steps.config.outputs.image-name }}
        PUSH_BY_DIGEST: ${{ inputs.push-by-digest }}
        IMAGE_DIGEST: ${{ steps.build.outputs.digest }}
        METADATA_TAGS: ${{ steps.meta.outputs.tags }}
      run: |
        if [ "$PUSH_BY_DIGEST" = "false" ]; then
          # Use the first tag from metadata output
          FIRST_TAG=$(echo "$METADATA_TAGS" | head -n 1)
          if [ -n "$FIRST_TAG" ]; then
            echo "image-ref=${FIRST_TAG}" >> $GITHUB_OUTPUT
          else
            # Fallback to digest if no tags
            echo "image-ref=${IMAGE_NAME}@${IMAGE_DIGEST}" >> $GITHUB_OUTPUT
          fi
        else
          # Push by digest - use digest reference
          echo "image-ref=${IMAGE_NAME}@${IMAGE_DIGEST}" >> $GITHUB_OUTPUT
        fi
